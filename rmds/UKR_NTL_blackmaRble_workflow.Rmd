---
title: 'UKR NTL: blackmaRble work-flow'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Intro

This rmd demonstrates how to reproject and mosaic rasters downloaded from WorldView.

Download data from LAADS world view and save h5 format rasters into folder in this directory call `ntl_h5`


```{r cars}
library(tidyverse)

# devtools::install_github("zackarno/blackmaRble")
library(blackmaRble)
library(here)
library(terra)
```

## Reproject VNP46A data

- using list of file names & list of of full path names we can read in all the files in the folder and reproject them all at once
- results are saved in list object: `ntl_reprojected`

```{r pressure, echo=FALSE}
# dir.create("ntl_h5")

write_batch <-  c(T,F)[1] # toggle 1 for write outputs, 2 for no outputs

h5_filenames <- list.files("ntl_h5/",pattern = "\\.h5$")
h5_paths <- list.files("ntl_h5/", full.names = T,pattern = "\\.h5$")


ntl_reprojected <- h5_paths |> 
  map(~vnp46A_to_wgs84(path =.x)) |> 
  set_names(h5_filenames)
```

## Subset bands

- to simplify list object lets just subset each item in list to the DNB band
- new object `dnb_radiance` contains only `DNB_At_Sensor_Radiance_500m` band for each item in list.

```{r}
# subset to just main band of interest for faster mosaicing
dnb_radiance <- ntl_reprojected |> 
  map(~.x |> subset("DNB_At_Sensor_Radiance_500m"))

```


# Mosaic & write rasters 
- since study area is composed of 4 tiles we need to mosaic them together
- function below uses NASA naming syntax to group tiles together by `DOY` and then mosaic them
- specify `output` to automatically write as tiff to specified directory
- result is also saved as spatRaster collection

```{r}
# dir.create("ntl_doy_tiffs")

if(write_batch){
  ntl_rad_by_doy <-  mosaic_vnp46a_by_doy(dnb_radiance,output = "ntl_doy_tiffs")
}
# ntl_rad_by_doy$`084`
```


